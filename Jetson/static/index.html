<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Validation - Jetson Orin Nano</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 20px 0;
            border-bottom: 2px solid #76b900;
            margin-bottom: 30px;
        }

        h1 {
            text-align: center;
            color: #76b900;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            text-align: center;
            color: #999;
            margin-top: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .status-item {
            text-align: center;
            padding: 10px;
        }

        .status-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .status-value {
            color: #76b900;
            font-size: 1.5em;
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        #videoCanvas {
            width: 100%;
            max-width: 100%;
            height: auto;
            background: #000;
            border-radius: 4px;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #76b900;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #8fd100;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(118, 185, 0, 0.3);
        }

        button:disabled {
            background: #444;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .metrics-panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .metric-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 4px;
            border-left: 3px solid #76b900;
        }

        .metric-label {
            color: #999;
            font-size: 0.85em;
        }

        .metric-value {
            color: #e0e0e0;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #76b900 0%, #8fd100 100%);
            transition: width 0.3s ease;
        }

        .detection-log {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .detection-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #0f0f0f;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }

        .detection-class {
            color: #76b900;
            font-weight: bold;
        }

        .detection-confidence {
            color: #999;
        }

        .camera-select {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            margin-right: 10px;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .info-message {
            background: #4444ff;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .controls {
                justify-content: center;
            }
        }

        /* GPU monitoring chart */
        #gpuChart {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }

        /* Network status indicator */
        .network-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #76b900;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            border: 1px solid #444;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-bottom: 2px solid #76b900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #76b900;
            margin: 0;
        }

        .close {
            color: #999;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #76b900;
        }

        .modal-body {
            padding: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #444;
            margin-bottom: 20px;
        }

        .tab-button {
            background: #2d2d2d;
            color: #999;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #76b900;
            border-bottom-color: #76b900;
            background: #1a1a1a;
        }

        .tab-button:hover {
            color: #e0e0e0;
            background: #1a1a1a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            color: #999;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #0f0f0f;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #76b900;
            box-shadow: 0 0 5px rgba(118, 185, 0, 0.3);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .stream-item {
            background: #0f0f0f;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-info h4 {
            color: #76b900;
            margin: 0 0 5px 0;
        }

        .stream-info p {
            color: #999;
            margin: 0;
            font-size: 0.9em;
        }

        .stream-actions {
            display: flex;
            gap: 8px;
        }

        .stream-actions button {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: #ff4444;
        }

        .btn-danger:hover {
            background: #ff6666;
        }

        .btn-warning {
            background: #ffaa00;
            color: #000;
        }

        .btn-warning:hover {
            background: #ffcc44;
        }

        .stream-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-enabled {
            background: #76b900;
            color: #000;
        }

        .status-disabled {
            background: #666;
            color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AI Model Validation - Jetson Orin Nano</h1>
            <p class="subtitle">High-Performance Edge AI with CUDA Acceleration</p>
            <div class="network-status">
                <span class="status-dot" id="connectionStatus"></span>
                <span id="connectionText">Disconnected</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="error-message" id="errorMessage"></div>
        
        <div class="info-message" id="deviceInfo">
            Detecting Jetson device...
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">FPS</div>
                <div class="status-value" id="fpsValue">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Objects Detected</div>
                <div class="status-value" id="objectCount">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">GPU Usage</div>
                <div class="status-value" id="gpuUsage">0%</div>
            </div>
            <div class="status-item">
                <div class="status-label">Temperature</div>
                <div class="status-value" id="gpuTemp">0°C</div>
            </div>
            <div class="status-item">
                <div class="status-label">Power</div>
                <div class="status-value" id="powerUsage">0W</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="video-container">
                <canvas id="videoCanvas"></canvas>
                <div class="controls">
                    <select id="cameraSelect" class="camera-select">
                        <option value="0">USB Camera (0)</option>
                        <option value="1">CSI Camera (1)</option>
                        <option value="test.mp4">Test Video</option>
                    </select>
                    <button id="startBtn" onclick="startStream()">Start Stream</button>
                    <button id="stopBtn" onclick="stopStream()" disabled>Stop Stream</button>
                    <button id="captureBtn" onclick="captureFrame()" disabled>Capture Frame</button>
                    <button id="recordBtn" onclick="toggleRecording()" disabled>Start Recording</button>
                    <button id="rtspBtn" onclick="showRTSPManager()">RTSP Streams</button>
                </div>
            </div>

            <div class="metrics-panel">
                <h3>Performance Metrics</h3>
                
                <div class="metric-item">
                    <div class="metric-label">GPU Memory</div>
                    <div class="metric-value" id="gpuMemory">0 / 0 MB</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="gpuMemoryBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value" id="cpuUsage">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cpuBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">Model</div>
                    <div class="metric-value">YOLOv8n-TensorRT</div>
                </div>

                <div class="metric-item">
                    <div class="metric-label">Inference Time</div>
                    <div class="metric-value" id="inferenceTime">0 ms</div>
                </div>

                <canvas id="gpuChart"></canvas>
            </div>
        </div>

        <div class="detection-log">
            <h3>Recent Detections</h3>
            <div id="detectionList"></div>
        </div>
    </div>

    <!-- RTSP Stream Manager Modal -->
    <div id="rtspModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>RTSP Stream Manager</h2>
                <span class="close" onclick="closeRTSPManager()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-button active" onclick="showTab('streams')">Streams</button>
                    <button class="tab-button" onclick="showTab('add')">Add Stream</button>
                    <button class="tab-button" onclick="showTab('profiles')">Camera Profiles</button>
                </div>
                
                <!-- Streams Tab -->
                <div id="streamsTab" class="tab-content active">
                    <div id="streamsList"></div>
                </div>
                
                <!-- Add Stream Tab -->
                <div id="addTab" class="tab-content">
                    <form id="addStreamForm">
                        <div class="form-group">
                            <label>Stream Name:</label>
                            <input type="text" id="streamName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>RTSP URL:</label>
                            <input type="url" id="streamUrl" placeholder="rtsp://..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description:</label>
                            <input type="text" id="streamDescription">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username:</label>
                                <input type="text" id="streamUsername">
                            </div>
                            
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="password" id="streamPassword">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Transport:</label>
                                <select id="streamTransport">
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                    <option value="auto">Auto</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="streamEnabled" checked>
                                    Enabled
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit">Add Stream</button>
                        <button type="button" onclick="testStreamUrl()">Test URL</button>
                    </form>
                </div>
                
                <!-- Camera Profiles Tab -->
                <div id="profilesTab" class="tab-content">
                    <div class="form-group">
                        <label>Camera Brand:</label>
                        <select id="cameraBrand" onchange="updateProfile()">
                            <option value="generic">Generic</option>
                            <option value="hikvision">Hikvision</option>
                            <option value="dahua">Dahua</option>
                            <option value="axis">Axis</option>
                            <option value="bosch">Bosch</option>
                            <option value="vivotek">Vivotek</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>IP Address:</label>
                            <input type="text" id="cameraIp" placeholder="192.168.1.100">
                        </div>
                        
                        <div class="form-group">
                            <label>Port:</label>
                            <input type="number" id="cameraPort" value="554">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Stream Type:</label>
                        <select id="streamType">
                            <option value="main">Main Stream (High Quality)</option>
                            <option value="sub">Sub Stream (Low Quality)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Generated URL:</label>
                        <input type="text" id="generatedUrl" readonly>
                    </div>
                    
                    <button onclick="generateUrl()">Generate URL</button>
                    <button onclick="addFromProfile()">Add to Streams</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ws = null;
        let canvas = null;
        let ctx = null;
        let streaming = false;
        let recording = false;
        let gpuHistory = [];
        let maxHistoryLength = 60;

        // Auto-detect server URL (works on LAN)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        const apiUrl = `${window.location.protocol}//${window.location.host}`;

        // Initialize on page load
        window.onload = function() {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 1280;
            canvas.height = 720;
            
            // Check device info
            checkDeviceInfo();
            
            // Initialize GPU chart
            initGPUChart();
            
            // Load camera sources including RTSP streams
            loadCameraSources();
            
            // Start metrics polling
            setInterval(updateMetrics, 1000);
        };

        async function checkDeviceInfo() {
            try {
                const response = await fetch(`${apiUrl}/system/info`);
                const data = await response.json();
                
                const infoDiv = document.getElementById('deviceInfo');
                infoDiv.innerHTML = `
                    <strong>Jetson Device:</strong> ${data.jetson.model} | 
                    <strong>JetPack:</strong> ${data.jetson.jetpack} | 
                    <strong>CUDA:</strong> ${data.cuda.split(' ').pop()} | 
                    <strong>Network:</strong> ${Object.keys(data.network).map(iface => 
                        `${iface}: ${data.network[iface]}`
                    ).join(', ')}
                `;
            } catch (error) {
                console.error('Failed to get device info:', error);
            }
        }

        function startStream() {
            if (streaming) return;
            
            const camera = document.getElementById('cameraSelect').value;
            const wsUrlWithParams = `${wsUrl}?camera=${camera}`;
            
            ws = new WebSocket(wsUrlWithParams);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                streaming = true;
                updateConnectionStatus(true);
                updateButtons();
            };
            
            ws.onmessage = function(event) {
                if (event.data instanceof ArrayBuffer) {
                    // Binary data - image frame
                    displayFrame(event.data);
                } else {
                    // Text data - metadata
                    try {
                        const metadata = JSON.parse(event.data);
                        updateStats(metadata);
                    } catch (e) {
                        console.error('Failed to parse metadata:', e);
                    }
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showError('WebSocket connection error');
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                streaming = false;
                updateConnectionStatus(false);
                updateButtons();
            };
        }

        function stopStream() {
            if (ws) {
                ws.close();
                ws = null;
            }
            streaming = false;
            updateButtons();
        }

        function displayFrame(arrayBuffer) {
            const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        function updateStats(metadata) {
            if (metadata.fps !== undefined) {
                document.getElementById('fpsValue').textContent = metadata.fps.toFixed(1);
            }
            if (metadata.detections !== undefined) {
                document.getElementById('objectCount').textContent = metadata.detections;
            }
            if (metadata.gpu_memory) {
                const mem = metadata.gpu_memory;
                const memText = `${mem.used_mb.toFixed(0)} / ${mem.total_mb.toFixed(0)} MB`;
                document.getElementById('gpuMemory').textContent = memText;
                document.getElementById('gpuMemoryBar').style.width = `${mem.utilization_percent}%`;
            }
        }

        async function updateMetrics() {
            if (!streaming) return;
            
            try {
                const response = await fetch(`${apiUrl}/metrics`);
                const metrics = await response.json();
                
                // Update GPU metrics
                if (metrics.gpu_utilization !== undefined) {
                    document.getElementById('gpuUsage').textContent = `${metrics.gpu_utilization}%`;
                    gpuHistory.push(metrics.gpu_utilization);
                    if (gpuHistory.length > maxHistoryLength) {
                        gpuHistory.shift();
                    }
                    updateGPUChart();
                }
                
                if (metrics.temperature_c !== undefined) {
                    document.getElementById('gpuTemp').textContent = `${metrics.temperature_c}°C`;
                }
                
                if (metrics.power_w !== undefined) {
                    document.getElementById('powerUsage').textContent = `${metrics.power_w.toFixed(1)}W`;
                }
                
                // Update CPU metrics
                if (metrics.cpu) {
                    document.getElementById('cpuUsage').textContent = `${metrics.cpu.percent}%`;
                    document.getElementById('cpuBar').style.width = `${metrics.cpu.percent}%`;
                }
                
                // Update inference time
                if (metrics.model && metrics.model.inference_time_ms) {
                    document.getElementById('inferenceTime').textContent = 
                        `${metrics.model.inference_time_ms.toFixed(1)} ms`;
                }
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        function initGPUChart() {
            const chartCanvas = document.getElementById('gpuChart');
            const chartCtx = chartCanvas.getContext('2d');
            chartCanvas.width = chartCanvas.offsetWidth;
            chartCanvas.height = 200;
        }

        function updateGPUChart() {
            const chartCanvas = document.getElementById('gpuChart');
            const chartCtx = chartCanvas.getContext('2d');
            const width = chartCanvas.width;
            const height = chartCanvas.height;
            
            // Clear canvas
            chartCtx.fillStyle = '#0a0a0a';
            chartCtx.fillRect(0, 0, width, height);
            
            // Draw grid
            chartCtx.strokeStyle = '#333';
            chartCtx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = (height / 10) * i;
                chartCtx.beginPath();
                chartCtx.moveTo(0, y);
                chartCtx.lineTo(width, y);
                chartCtx.stroke();
            }
            
            // Draw GPU usage line
            if (gpuHistory.length > 1) {
                chartCtx.strokeStyle = '#76b900';
                chartCtx.lineWidth = 2;
                chartCtx.beginPath();
                
                const stepX = width / (maxHistoryLength - 1);
                for (let i = 0; i < gpuHistory.length; i++) {
                    const x = i * stepX;
                    const y = height - (gpuHistory[i] / 100) * height;
                    
                    if (i === 0) {
                        chartCtx.moveTo(x, y);
                    } else {
                        chartCtx.lineTo(x, y);
                    }
                }
                chartCtx.stroke();
            }
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        function updateButtons() {
            document.getElementById('startBtn').disabled = streaming;
            document.getElementById('stopBtn').disabled = !streaming;
            document.getElementById('captureBtn').disabled = !streaming;
            document.getElementById('recordBtn').disabled = !streaming;
            document.getElementById('cameraSelect').disabled = streaming;
        }

        function captureFrame() {
            if (!streaming) return;
            
            // Convert canvas to blob and download
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `capture_${new Date().toISOString()}.jpg`;
                a.click();
                URL.revokeObjectURL(url);
            }, 'image/jpeg', 0.95);
        }

        function toggleRecording() {
            recording = !recording;
            const btn = document.getElementById('recordBtn');
            btn.textContent = recording ? 'Stop Recording' : 'Start Recording';
            
            if (recording) {
                // Start recording logic
                showError('Recording feature not yet implemented');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function addDetection(className, confidence) {
            const list = document.getElementById('detectionList');
            const item = document.createElement('div');
            item.className = 'detection-item';
            item.innerHTML = `
                <span class="detection-class">${className}</span>
                <span class="detection-confidence">${(confidence * 100).toFixed(1)}%</span>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // Keep only last 20 detections
            while (list.children.length > 20) {
                list.removeChild(list.lastChild);
            }
        }

        // RTSP Stream Management Functions
        async function loadCameraSources() {
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams/enabled`);
                const data = await response.json();
                
                const cameraSelect = document.getElementById('cameraSelect');
                
                // Clear existing options except USB/CSI cameras
                while (cameraSelect.children.length > 3) {
                    cameraSelect.removeChild(cameraSelect.lastChild);
                }
                
                // Add RTSP streams
                data.camera_sources.forEach(source => {
                    if (source.type === 'rtsp') {
                        const option = document.createElement('option');
                        option.value = source.value;
                        option.textContent = source.label;
                        cameraSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Failed to load camera sources:', error);
            }
        }

        function showRTSPManager() {
            document.getElementById('rtspModal').style.display = 'block';
            loadRTSPStreams();
        }

        function closeRTSPManager() {
            document.getElementById('rtspModal').style.display = 'none';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'streams') {
                loadRTSPStreams();
            } else if (tabName === 'profiles') {
                loadCameraProfiles();
            }
        }

        async function loadRTSPStreams() {
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams`);
                const data = await response.json();
                
                const streamsList = document.getElementById('streamsList');
                streamsList.innerHTML = '';
                
                if (data.streams.length === 0) {
                    streamsList.innerHTML = '<p>No RTSP streams configured.</p>';
                    return;
                }
                
                data.streams.forEach(stream => {
                    const streamItem = document.createElement('div');
                    streamItem.className = 'stream-item';
                    streamItem.innerHTML = `
                        <div class="stream-info">
                            <h4>${stream.name}</h4>
                            <p>${stream.description}</p>
                            <p><strong>URL:</strong> ${stream.url}</p>
                            <p><strong>Transport:</strong> ${stream.transport.toUpperCase()}</p>
                            <span class="stream-status ${stream.enabled ? 'status-enabled' : 'status-disabled'}">
                                ${stream.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                        <div class="stream-actions">
                            <button onclick="testStream('${stream.name}')">Test</button>
                            <button class="btn-warning" onclick="toggleStream('${stream.name}', ${!stream.enabled})">
                                ${stream.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn-danger" onclick="deleteStream('${stream.name}')">Delete</button>
                        </div>
                    `;
                    streamsList.appendChild(streamItem);
                });
            } catch (error) {
                console.error('Failed to load RTSP streams:', error);
                showError('Failed to load RTSP streams');
            }
        }

        async function loadCameraProfiles() {
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/camera-profiles`);
                const data = await response.json();
                
                // Update camera brand select with available profiles
                const brandSelect = document.getElementById('cameraBrand');
                brandSelect.innerHTML = '';
                
                Object.keys(data.profiles).forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                    brandSelect.appendChild(option);
                });
                
                updateProfile();
            } catch (error) {
                console.error('Failed to load camera profiles:', error);
            }
        }

        function updateProfile() {
            const brand = document.getElementById('cameraBrand').value;
            
            // Update port based on brand defaults
            const defaultPorts = {
                'generic': 554,
                'hikvision': 554,
                'dahua': 554,
                'axis': 554,
                'bosch': 554,
                'vivotek': 554
            };
            
            document.getElementById('cameraPort').value = defaultPorts[brand] || 554;
            generateUrl();
        }

        async function generateUrl() {
            const ip = document.getElementById('cameraIp').value;
            const brand = document.getElementById('cameraBrand').value;
            const streamType = document.getElementById('streamType').value;
            const port = document.getElementById('cameraPort').value;
            
            if (!ip) {
                document.getElementById('generatedUrl').value = '';
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/generate-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip: ip,
                        brand: brand,
                        stream_type: streamType,
                        port: parseInt(port)
                    })
                });
                
                const data = await response.json();
                document.getElementById('generatedUrl').value = data.url;
            } catch (error) {
                console.error('Failed to generate URL:', error);
            }
        }

        function addFromProfile() {
            const url = document.getElementById('generatedUrl').value;
            const ip = document.getElementById('cameraIp').value;
            const brand = document.getElementById('cameraBrand').value;
            
            if (!url || !ip) {
                showError('Please generate a URL first');
                return;
            }
            
            // Fill add stream form
            document.getElementById('streamName').value = `${brand}_${ip}`;
            document.getElementById('streamUrl').value = url;
            document.getElementById('streamDescription').value = `${brand.charAt(0).toUpperCase() + brand.slice(1)} camera at ${ip}`;
            
            // Switch to add tab
            showTab('add');
        }

        // Form submission
        document.getElementById('addStreamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const streamData = {
                name: document.getElementById('streamName').value,
                url: document.getElementById('streamUrl').value,
                description: document.getElementById('streamDescription').value,
                username: document.getElementById('streamUsername').value,
                password: document.getElementById('streamPassword').value,
                transport: document.getElementById('streamTransport').value,
                enabled: document.getElementById('streamEnabled').checked
            };
            
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(streamData)
                });
                
                if (response.ok) {
                    // Clear form
                    document.getElementById('addStreamForm').reset();
                    document.getElementById('streamEnabled').checked = true;
                    
                    // Reload streams and camera sources
                    loadRTSPStreams();
                    loadCameraSources();
                    
                    // Switch to streams tab
                    showTab('streams');
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Failed to add stream');
                }
            } catch (error) {
                console.error('Failed to add stream:', error);
                showError('Failed to add stream');
            }
        });

        async function testStream(streamName) {
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams/${streamName}/test`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Stream test successful!\nResolution: ${result.resolution}`);
                } else {
                    alert(`Stream test failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Stream test error:', error);
                alert('Stream test failed');
            }
        }

        async function toggleStream(streamName, enabled) {
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams/${streamName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled: enabled })
                });
                
                if (response.ok) {
                    loadRTSPStreams();
                    loadCameraSources();
                } else {
                    showError('Failed to update stream');
                }
            } catch (error) {
                console.error('Failed to toggle stream:', error);
                showError('Failed to update stream');
            }
        }

        async function deleteStream(streamName) {
            if (!confirm(`Are you sure you want to delete stream "${streamName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}/api/rtsp/streams/${streamName}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadRTSPStreams();
                    loadCameraSources();
                } else {
                    showError('Failed to delete stream');
                }
            } catch (error) {
                console.error('Failed to delete stream:', error);
                showError('Failed to delete stream');
            }
        }

        async function testStreamUrl() {
            const url = document.getElementById('streamUrl').value;
            if (!url) {
                showError('Please enter a stream URL');
                return;
            }
            
            // Create a temporary stream for testing
            const tempStream = {
                name: 'temp_test',
                url: url,
                username: document.getElementById('streamUsername').value,
                password: document.getElementById('streamPassword').value,
                transport: document.getElementById('streamTransport').value,
                enabled: true,
                description: 'Temporary test stream'
            };
            
            try {
                // Add temporary stream
                await fetch(`${apiUrl}/api/rtsp/streams`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tempStream)
                });
                
                // Test it
                const testResponse = await fetch(`${apiUrl}/api/rtsp/streams/temp_test/test`, {
                    method: 'POST'
                });
                
                const result = await testResponse.json();
                
                // Delete temporary stream
                await fetch(`${apiUrl}/api/rtsp/streams/temp_test`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    alert(`Stream test successful!\nResolution: ${result.resolution}`);
                } else {
                    alert(`Stream test failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Stream test error:', error);
                alert('Stream test failed');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('rtspModal');
            if (event.target === modal) {
                closeRTSPManager();
            }
        }
    </script>
</body>
</html>